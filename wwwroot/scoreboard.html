<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script type="text/javascript">
        var appInsights = window.appInsights || function (a) {
            function b(a) { c[a] = function () { var b = arguments; c.queue.push(function () { c[a].apply(c, b) }) } } var c = { config: a }, d = document, e = window; setTimeout(function () { var b = d.createElement("script"); b.src = a.url || "https://az416426.vo.msecnd.net/scripts/a/ai.0.js", d.getElementsByTagName("script")[0].parentNode.appendChild(b) }); try { c.cookie = d.cookie } catch (a) { } c.queue = []; for (var f = ["Event", "Exception", "Metric", "PageView", "Trace", "Dependency"]; f.length;)b("track" + f.pop()); if (b("setAuthenticatedUserContext"), b("clearAuthenticatedUserContext"), b("startTrackEvent"), b("stopTrackEvent"), b("startTrackPage"), b("stopTrackPage"), b("flush"), !a.disableExceptionTracking) { f = "onerror", b("_" + f); var g = e[f]; e[f] = function (a, b, d, e, h) { var i = g && g(a, b, d, e, h); return !0 !== i && c["_" + f](a, b, d, e, h), i } } return c
        }({
            instrumentationKey: "bf6335cf-cdf8-48b0-8aa2-82d4a6a3ed8f"
        });

        window.appInsights = appInsights, appInsights.queue && 0 === appInsights.queue.length && appInsights.trackPageView();
    </script>
</head>

<body>
    <section class="section">
        <div class="container">
            <h1 class="title">
                Baseball Scoreboard
            </h1>
            <p class="subtitle">Select a Team to Follow...</p>
            <div class="level-left">
                <div class="level-item">
                    <div class="select is-large is-primary">
                        <select id="teamList">
                            <option value="ANA">Anaheim Angels</option>
                            <option value="BAL">Baltimore Orioles</option>
                            <option value="BOS">Boston Red Sox</option>
                            <option value="CHA">Chicago White Sox</option>
                            <option value="CLE">Cleveland Indians</option>
                            <option value="DET">Detroit Tigers</option>
                            <option value="HOU">Houston Astros</option>
                            <option value="KCA">Kansas City Royals</option>
                            <option value="MIN">Minnesota Twins</option>
                            <option value="NYA">New York Yankees</option>
                            <option value="OAK">Oakland Athletics</option>
                            <option value="SEA">Seattle Mariners</option>
                            <option value="TBA">Tampa Bay Rays</option>
                            <option value="TEX">Texas Rangers</option>
                            <option value="TOR">Toronto Blue Jays</option>
                            <option value="ARI">Arizona Diamondbacks</option>
                            <option value="ATL">Atlanta Braves</option>
                            <option value="CHN">Chicago Cubs</option>
                            <option value="CIN">Cincinnati Reds</option>
                            <option value="COL">Colorado Rockies</option>
                            <option value="LAN">Los Angeles Dodgers</option>
                            <option value="MIA">Miami Marlins</option>
                            <option value="MIL">Milwaukee Brewers</option>
                            <option value="NYN">New York Mets</option>
                            <option value="PHI">Philadelphia Phillies</option>
                            <option value="PIT">Pittsburgh Pirates</option>
                            <option value="SDN">San Diego Padres</option>
                            <option value="SFN">San Francisco Giants</option>
                            <option value="SLN">St. Louis Cardinals</option>
                            <option value="WAS">Washington Nationals</option>
                        </select>
                    </div>
                </div>
                <div class="level-item">
                    <button id="followBtn" class="button is-primary is-large">Follow</button>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item" id="notification-area">
                </div>
            </div>
        </div>
    </section>
    <section class="hero is-success">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    Team Scores
                </h1>
            </div>
        </div>
        <div id='teamColumns' class="columns">
            <!-- <div id="col-PIT" class="column">
                <h2 class="subtitle">Pirates</h2>
                <div id="game-123">
                    <p id="game-123-header"><strong>03/31/2018 PIT vs ARI</strong></p>
                    <p id="game-123-home">PIT - 3</p>
                    <p id="game-123-visitor">ARI - 5</p>
                    <p id="game-123-update">blah blah blah</p>
                </div>
            </div>
            <div id="col-PHI" class="column">
                <h2 class="subtitle">Phillies</h2>
            </div> -->
        </div>
    </section>


    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.0/dist/browser/signalr.min.js"></script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
                $notification = $delete.parentNode;
                $delete.addEventListener('click', () => {
                    $notification.parentNode.removeChild($notification);
                });
            });


            var connection = new signalR.HubConnectionBuilder()
                .withUrl('/baseball')
                .build();


            function bindConnectionMessage(connection) {
                var addNotification = function (msg) {
                    console.log(msg);
                    // var notiarea = document.getElementById('notification-area');
                    // var newNote = document.createElement('div');
                    // newNote.classList.add('notification');
                    // newNote.classList.add('is-info');

                    // var delBtn = document.createElement('button');
                    // delBtn.classList.add('delete');

                    // var notitext = document.createTextNode(msg);
                    // newNote.appendChild(delBtn);
                    // newNote.appendChild(notitext);
                    // notiarea.appendChild(newNote);
                };

                var updateGameBoxScore = function (team, evt) {
                    console.log('message received for ' + team);
                    var col = document.getElementById('col-' + team);
                    var game = document.getElementById('game-' + evt.gameId);

                    var gameBody;

                    var isHomeAtBat = evt.isHomeTeamAtBat == 1;

                    if (game) {
                        //box score found...let's grab handles
                        gameBody = document.getElementById('game-' + evt.gameId + '-body');
                        while (gameBody.firstChild) {
                            gameBody.removeChild(gameBody.firstChild);
                        }
                    } else {
                        //need to create box score
                        var title = document.createElement('h3');
                        title.innerHTML = "<strong>" + evt.date + "</strong>";

                        game = document.createElement('table');
                        game.classList.add('table');
                        game.classList.add('is-fullwidth');
                        game.setAttribute('id', 'game-' + evt.gameId);

                        game.innerHTML = '<thead><tr><th></th><th>Team</th><th>Inning</th><th><abbr title="Runs">R</abbr></th><th>Balls</th><th>Strikes</th><th>Outs</th><th>Pitcher</th><th>At Bat</th><th>Event</th></tr></thead>';
                        gameBody = document.createElement('tbody');
                        gameBody.setAttribute('id', 'game-' + evt.gameId + '-body');
                        game.appendChild(gameBody);

                        gameBody.innerHTML = "<tr><td colspan='5'><strong>" + evt.date + "</strong></td></tr>";

                        col.insertBefore(game, col.childNodes[0]);
                        col.insertBefore(title, col.childNodes[0]);
                    }

                    // var homeRow = document.createElement('tr');
                    var homeStr = "<tr>";
                    if (isHomeAtBat) {
                        homeStr += '<td><i class="fas fa-angle-right"></i></td>';
                        homeStr += '<td>' + evt.homeTeam + '</td>';
                        homeStr += '<td>' + evt.innin + '</td>';
                        homeStr += '<td>' + evt.homeScore + '</td>';
                        homeStr += '<td>' + evt.balls + '</td>';
                        homeStr += '<td>' + evt.strikes + '</td>';
                        homeStr += '<td>' + evt.outs + '</td>';
                        homeStr += '<td></td>';    //pitcher
                        homeStr += '<td>' + evt.batter + '</td>';
                        homeStr += '<td>' + evt.eventText + '</td>';
                    } else {
                        homeStr += '<td></td><td>' + evt.homeTeam + '</td><td></td><td>' + evt.homeScore + '</td><td></td><td></td><td></td><td>' + evt.pitcher + '</td><td></td><td></td>';
                    }
                    homeStr += "</tr>";

                    // var visitorRow = document.createElement('tr');
                    var visitorStr = "<tr>";
                    if (!isHomeAtBat) {
                        visitorStr += '<td><i class="fas fa-angle-right"></i></td>';
                        visitorStr += '<td>' + evt.visitingTeam + '</td>';
                        visitorStr += '<td>' + evt.innin + '</td>';
                        visitorStr += '<td>' + evt.visitorScore + '</td>';
                        visitorStr += '<td>' + evt.balls + '</td>';
                        visitorStr += '<td>' + evt.strikes + '</td>';
                        visitorStr += '<td>' + evt.outs + '</td>';
                        visitorStr += '<td></td>'; //pitcher
                        visitorStr += '<td>' + evt.batter + '</td>';
                        visitorStr += '<td>' + evt.eventText + '</td>';
                    } else {
                        visitorStr += '<td></td><td>' + evt.visitingTeam + '</td><td></td><td>' + evt.visitorScore + '</td><td></td><td></td><td></td><td>' + evt.pitcher + '</td><td></td><td></td>';
                    }
                    visitorStr += "</tr>";
                    gameBody.innerHTML += homeStr;
                    gameBody.innerHTML += visitorStr;

                    if (evt.isEndOfGame == 'T') {
                        gameBody.innerHTML += "<tr><td colspan='4'><strong>FINAL</strong></td></tr>";
                    }
                };

                // var addEventUpdate = function (team, evt) {
                //     console.log('message received for ' + team);

                //     var col = document.getElementById('col-' + team);
                //     var game = document.getElementById('game-' + evt.gameId);
                //     var header, homescore, visitorScore, eventText;

                //     var atbatIndicator = document.createElement('i');
                //     atbatIndicator.classList.add('fas');
                //     atbatIndicator.classList.add('fa-angle-right');

                //     var isHomeAtBat = evt.isHomeTeamAtBat == 1;
                //     if (game) {
                //         //use existing div for game                        
                //         homescore = document.getElementById('game-' + evt.gameId + '-home');
                //         while (homescore.firstChild) {
                //             homescore.removeChild(homescore.firstChild);
                //         }
                //         visitorScore = document.getElementById('game-' + evt.gameId + '-visitor');
                //         while (visitorScore.firstChild) {
                //             visitorScore.removeChild(visitorScore.firstChild);
                //         }
                //         eventText = document.getElementById('game-' + evt.gameId + '-update');
                //         while (eventText.firstChild) {
                //             eventText.removeChild(eventText.firstChild);
                //         }
                //     } else {
                //         //create new div for game
                //         game = document.createElement('div');
                //         game.setAttribute('id', 'game-' + evt.gameId);

                //         header = document.createElement('p');
                //         header.setAttribute('id', 'game-' + evt.gameId + '-header');
                //         var strongHeader = document.createElement('strong');
                //         strongHeader.innerText = evt.date + ' ' + evt.homeTeam + ' vs ' + evt.visitingTeam;
                //         header.appendChild(strongHeader);
                //         game.appendChild(header);

                //         homescore = document.createElement('p');
                //         homescore.setAttribute('id', 'game-' + evt.gameId + '-home');
                //         game.appendChild(homescore);

                //         visitorScore = document.createElement('p');
                //         visitorScore.setAttribute('id', 'game-' + evt.gameId + '-visitor');
                //         game.appendChild(visitorScore);

                //         eventText = document.createElement('p');
                //         eventText.setAttribute('id', 'game-' + evt.gameId + '-update');
                //         game.appendChild(eventText);

                //         col.appendChild(game);
                //     }
                //     if (isHomeAtBat) {
                //         homescore.appendChild(atbatIndicator);
                //     } else {
                //         visitorScore.appendChild(atbatIndicator);
                //     }
                //     homescore.append(evt.homeTeam + ' - ' + evt.homeScore);
                //     visitorScore.append(evt.visitingTeam + ' - ' + evt.visitorScore);
                //     eventText.append(evt.eventText);

                // };

                connection.on('broadcast', addNotification);
                connection.on('echo', addNotification);
                connection.on('sendEvent', updateGameBoxScore);

                connection.onclose(onConnectionError);
            }


            function onConnected(connection) {
                console.log('connection started');
                document.getElementById('followBtn').addEventListener('click', function (event) {
                    var sel = document.getElementById('teamList');
                    if (sel.value) {
                        connection.send('followTeam', sel.value);
                        event.preventDefault();

                        var cols = document.getElementById('teamColumns');
                        var col = document.getElementById('col-' + sel.value);
                        if (col) {
                            //do nothing
                        } else {
                            //create column
                            col = document.createElement('div');
                            col.classList.add('column');
                            col.setAttribute('id', 'col-' + sel.value);

                            var h2 = document.createElement('h2');
                            h2.classList.add('subtitle');
                            h2.innerText = sel.value;
                            col.appendChild(h2);

                            cols.appendChild(col);

                        }
                    }
                })
            }


            function onConnectionError(error) {
                if (error && error.message) {
                    console.error(error.message);
                }
            }


            bindConnectionMessage(connection);
            connection.start()
                .then(function () {
                    onConnected(connection);
                })
                .catch(function (error) {
                    console.error(error.message);
                });
        });
    </script>


</body>

</html>